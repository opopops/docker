name: dagger
on:
  push:
    branches:
      - 'main'
    paths:
      - 'opopops/**'
  workflow_dispatch:

jobs:
  release:
    name: release
    runs-on: self-hosted
    environment: main
    steps:
      - uses: actions/checkout@v3
      -
        name: Release Opopops Docker images
        uses: dagger/dagger-for-github@v5
        env:
          REGISTRY: docker.io
          REGISTRY_USERNAME: opopops
          REGISTRY_PASSWORD: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        with:
          version: "0.10.3"
          verb: call
          module: github.com/opopops/docker@main
          args: |
            release \
            --src=${REGISTRY_USERNAME} \
            --registry=${REGISTRY}/${REGISTRY_USERNAME} \
            --username=${REGISTRY_USERNAME} \
            --password=env:REGISTRY_PASSWORD \
            --platforms="linux/amd64,linux/arm64" \
            --sign \
            --cosign-password=env:COSIGN_PASSWORD \
            --cosign-private-key=env:COSIGN_PRIVATE_KEY \
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
