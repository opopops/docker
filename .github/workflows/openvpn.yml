name: openvpn

on:
  push:
    branches:
      - "main"
    paths:
      - "opopops/openvpn/**"
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

jobs:
  latest:
    if: github.ref_name == 'main'
    name: latest
    environment: main
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Publish
        id: publish
        uses: ./.github/actions/apko
        with:
          config: opopops/openvpn/apko/base.yaml
          tag: opopops/openvpn:latest
          dockerhub-username: ${{ vars.DOCKER_REGISTRY_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          cosign-private-key: ${{ secrets.COSIGN_PRIVATE_KEY }}
          cosign-public-key: ${{ vars.COSIGN_PUBLIC_KEY }}

  latest-dev:
    if: github.ref_name == 'main'
    name: latest-dev
    environment: main
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Publish
        id: publish
        uses: ./.github/actions/apko
        with:
          config: opopops/openvpn/apko/dev.yaml
          tag: opopops/openvpn:latest-dev
          dockerhub-username: ${{ vars.DOCKER_REGISTRY_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          cosign-private-key: ${{ secrets.COSIGN_PRIVATE_KEY }}
          cosign-public-key: ${{ vars.COSIGN_PUBLIC_KEY }}

  unstable:
    if: github.ref_name == 'dev'
    name: unstable
    environment: main
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Publish
        id: publish
        uses: ./.github/actions/apko
        with:
          config: opopops/openvpn/apko/base.yaml
          tag: opopops/openvpn:unstable
          dockerhub-username: ${{ vars.DOCKER_REGISTRY_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          cosign: "false"

  unstable-dev:
    if: github.ref_name == 'dev'
    name: unstable-dev
    environment: main
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Publish
        id: publish
        uses: ./.github/actions/apko
        with:
          config: opopops/openvpn/apko/dev.yaml
          tag: opopops/openvpn:unstable-dev
          dockerhub-username: ${{ vars.DOCKER_REGISTRY_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          cosign: "false"
